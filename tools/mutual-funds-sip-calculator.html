<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unified Financial Calculator (SIP, Lumpsum, SWP)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for dynamic charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load Chart.js Datalabels Plugin for Pie Chart labels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
      /* Define custom Tailwind configuration */
      :root {
        --primary-color: #6366f1; /* Indigo-500 */
        --background-start: #f1f5f9; /* Slate-100 (Light) */
        --background-end: #e2e8f0; /* Slate-200 (Light) */
        --card-bg: rgba(255, 255, 255, 0.85); /* Light Glass */
        --text-color: #1e293b; /* Slate-800 */
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .dark {
        --background-start: #1e293b; /* Slate-800 (Dark) */
        --background-end: #0f172a; /* Slate-900 (Dark) */
        --card-bg: rgba(30, 41, 59, 0.7); /* Dark Glass */
        --text-color: #f1f5f9; /* Slate-100 */
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(
          135deg,
          var(--background-start),
          var(--background-end)
        );
        min-height: 100vh;
        color: var(--text-color);
        transition: background 0.5s ease, color 0.5s ease;
      }

      /* Glassmorphism Card Style */
      .glass-card {
        background-color: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: var(--shadow);
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      /* Custom Slider Styling for better contrast */
      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        background: #cbd5e1; /* Slate-300 */
        border-radius: 4px;
        outline: none;
        transition: opacity 0.2s;
      }

      .dark input[type="range"] {
        background: #475569; /* Slate-600 */
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: background 0.3s;
      }

      /* Custom scrollbar for subtle look */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <!-- Dark/Light Mode Toggle -->
    <div class="fixed top-4 right-4 z-50">
      <button
        id="themeToggle"
        class="p-3 rounded-full glass-card hover:shadow-lg transition-all duration-300"
      >
        <!-- Moon icon (Dark Mode) -->
        <svg
          id="moonIcon"
          class="w-6 h-6 text-gray-700 dark:text-yellow-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          ></path>
        </svg>
        <!-- Sun icon (Light Mode) -->
        <svg
          id="sunIcon"
          class="w-6 h-6 text-yellow-500 dark:text-gray-200 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Main Application Container -->
    <main class="max-w-6xl mx-auto py-4">
      <h1
        class="text-3xl md:text-4xl font-extrabold mb-8 text-center bg-clip-text text-transparent"
        style="
          background-image: linear-gradient(
            90deg,
            var(--primary-color),
            #8b5cf6
          );
        "
      >
        Financial Goal Planner & Withdrawal Tracker
      </h1>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Inputs and Results (Col 1/3) -->
        <div class="lg:col-span-1 space-y-6">
          <!-- Investment Mode Toggle -->
          <div class="glass-card p-4 rounded-xl">
            <h2 class="text-xl font-semibold mb-3">Calculation Mode</h2>
            <div
              class="flex space-x-2 p-1 bg-gray-200 dark:bg-slate-700 rounded-lg text-sm transition-colors duration-300"
            >
              <button
                id="sipModeBtn"
                class="flex-1 py-2 px-2 rounded-lg font-medium transition-all duration-300 bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-400 shadow-md"
              >
                SIP
              </button>
              <button
                id="lumpsumModeBtn"
                class="flex-1 py-2 px-2 rounded-lg font-medium transition-all duration-300 text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-500/50"
              >
                Lumpsum
              </button>
              <button
                id="swpModeBtn"
                class="flex-1 py-2 px-2 rounded-lg font-medium transition-all duration-300 text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-500/50"
              >
                SWP
              </button>
            </div>
          </div>

          <!-- SIP/SWP Frequency Selector (Hidden when Lumpsum) -->
          <div id="frequencyCard" class="glass-card p-4 rounded-xl">
            <h2 class="text-xl font-semibold mb-3" id="frequencyTitle">
              SIP Frequency
            </h2>
            <div
              class="flex space-x-2 p-1 bg-gray-200 dark:bg-slate-700 rounded-lg text-sm transition-colors duration-300"
            >
              <button
                id="monthlyFreqBtn"
                data-freq="Monthly"
                class="flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-400 shadow-md"
              >
                Monthly
              </button>
              <button
                id="weeklyFreqBtn"
                data-freq="Weekly"
                class="flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-500/50"
              >
                Weekly
              </button>
              <button
                id="dailyFreqBtn"
                data-freq="Daily"
                class="flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-500/50"
              >
                Daily
              </button>
            </div>
          </div>

          <!-- Input Controls Card -->
          <div class="glass-card p-6 rounded-xl">
            <h2 class="text-xl font-semibold mb-4" id="inputCardTitle">
              Investment Parameters
            </h2>

            <!-- 1. Principal/Investment/Corpus Amount Input -->
            <div class="mb-5">
              <label
                for="principalAmount"
                class="block text-sm font-medium mb-2"
                id="principalLabel"
                >Monthly Investment (₹)</label
              >
              <div class="relative mb-2">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                  >₹</span
                >
                <input
                  type="number"
                  id="principalAmount"
                  value="5000"
                  min="500"
                  max="100000"
                  step="500"
                  class="w-full py-3 pl-8 pr-4 rounded-lg border-2 border-indigo-200 dark:border-indigo-800 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-slate-700 text-sm transition-colors duration-300"
                />
              </div>
              <input
                type="range"
                id="principalAmountSlider"
                min="500"
                max="100000"
                step="500"
                value="5000"
                class="w-full h-2 rounded-full cursor-pointer"
              />
              <div class="flex justify-between text-xs mt-1 text-gray-500">
                <span id="principalMin">₹500</span
                ><span id="principalMax">₹1,00,000</span>
              </div>
            </div>

            <!-- 2. Expected Annual Return (%) -->
            <div class="mb-5">
              <label for="expectedReturn" class="block text-sm font-medium mb-2"
                >Expected Annual Return (%)</label
              >
              <div class="relative mb-2">
                <input
                  type="number"
                  id="expectedReturn"
                  value="12"
                  min="1"
                  max="30"
                  step="0.5"
                  class="w-full py-3 pr-8 pl-4 rounded-lg border-2 border-indigo-200 dark:border-indigo-800 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-slate-700 text-sm transition-colors duration-300"
                />
                <span
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                  >%</span
                >
              </div>
              <input
                type="range"
                id="expectedReturnSlider"
                min="1"
                max="30"
                step="0.5"
                value="12"
                class="w-full h-2 rounded-full cursor-pointer"
              />
              <div class="flex justify-between text-xs mt-1 text-gray-500">
                <span>1%</span><span>30%</span>
              </div>
            </div>

            <!-- 3. Withdrawal/Investment Duration (Years) -->
            <div class="mb-2">
              <label
                for="duration"
                class="block text-sm font-medium mb-2"
                id="durationLabel"
                >Investment Duration (Years)</label
              >
              <div class="relative mb-2">
                <input
                  type="number"
                  id="duration"
                  value="10"
                  min="1"
                  max="100"
                  step="1"
                  class="w-full py-3 pr-10 pl-4 rounded-lg border-2 border-indigo-200 dark:border-indigo-800 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-slate-700 text-sm transition-colors duration-300"
                />
                <span
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                  >Yrs</span
                >
              </div>
              <input
                type="range"
                id="durationSlider"
                min="1"
                max="100"
                step="1"
                value="10"
                class="w-full h-2 rounded-full cursor-pointer"
              />
              <div class="flex justify-between text-xs mt-1 text-gray-500">
                <span>1 Yr</span><span>100 Yrs</span>
              </div>
            </div>

            <!-- 4. SWP Withdrawal Rate/Amount Input (SWP Mode ONLY) -->
            <div id="swpWithdrawalInput" class="mb-5 hidden">
              <label
                for="withdrawalRate"
                class="block text-sm font-medium mb-2"
                id="withdrawalRateLabel"
                >Annual Withdrawal Rate (%)</label
              >
              <div class="relative mb-2">
                <input
                  type="number"
                  id="withdrawalRate"
                  value="4"
                  min="0.5"
                  max="20"
                  step="0.1"
                  class="w-full py-3 pr-8 pl-4 rounded-lg border-2 border-indigo-200 dark:border-indigo-800 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-slate-700 text-sm transition-colors duration-300"
                />
                <span
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                  >%</span
                >
              </div>
              <input
                type="range"
                id="withdrawalRateSlider"
                min="0.5"
                max="20"
                step="0.1"
                value="4"
                class="w-full h-2 rounded-full cursor-pointer"
              />
              <div class="flex justify-between text-xs mt-1 text-gray-500">
                <span>0.5%</span><span>20%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Results and Charts (Col 2/3 and 3/3) -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Results Display Card -->
          <div class="glass-card p-6 rounded-xl transition-all duration-300">
            <h2
              class="text-2xl font-bold text-center mb-6 text-indigo-600 dark:text-indigo-400"
              id="resultsTitle"
            >
              Maturity Projection
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <!-- Total Invested/Initial Corpus -->
              <div
                class="text-center p-3 border-b-2 sm:border-b-0 sm:border-r-2 border-indigo-200 dark:border-indigo-800"
              >
                <p class="text-sm font-medium opacity-75" id="metric1Label">
                  Total Invested Amount
                </p>
                <p
                  id="metric1Value"
                  class="text-xl md:text-2xl font-extrabold mt-1 text-gray-700 dark:text-gray-200"
                >
                  ₹0
                </p>
              </div>
              <!-- Estimated Returns/Total Withdrawal -->
              <div
                class="text-center p-3 border-b-2 sm:border-b-0 sm:border-r-2 border-indigo-200 dark:border-indigo-800"
              >
                <p class="text-sm font-medium opacity-75" id="metric2Label">
                  Estimated Returns
                </p>
                <p
                  id="metric2Value"
                  class="text-xl md:text-2xl font-extrabold mt-1 text-green-600 dark:text-green-400"
                >
                  ₹0
                </p>
              </div>
              <!-- Final Value/Corpus -->
              <div class="text-center p-3">
                <p class="text-sm font-medium opacity-75" id="metric3Label">
                  Final Maturity Value
                </p>
                <p
                  id="metric3Value"
                  class="text-2xl md:text-3xl font-black mt-1 text-indigo-700 dark:text-indigo-300"
                >
                  ₹0
                </p>
              </div>
            </div>

            <!-- SWP Exhaustion Warning -->
            <div
              id="swpWarning"
              class="hidden mt-6 p-3 bg-red-100 dark:bg-red-900 border-l-4 border-red-500 rounded-lg text-red-700 dark:text-red-300"
            >
              <p class="font-semibold" id="swpWarningText">
                Corpus exhausted after X years.
              </p>
            </div>
          </div>

          <!-- Charts and Visualization -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Pie Chart: Invested vs Returns -->
            <div class="glass-card p-6 rounded-xl">
              <h3
                class="text-lg font-semibold mb-4 text-center"
                id="pieChartTitle"
              >
                Invested vs. Returns
              </h3>
              <canvas id="pieChart" class="w-full"></canvas>
            </div>

            <!-- Line Chart: Growth Over Years -->
            <div class="glass-card p-6 rounded-xl">
              <h3
                class="text-lg font-semibold mb-4 text-center"
                id="lineChartTitle"
              >
                Investment Growth Over Time
              </h3>
              <canvas id="lineChart" class="w-full"></canvas>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Global state and constants
      let calculationMode = "SIP"; // 'SIP', 'Lumpsum', or 'SWP'
      let periodFrequency = "Monthly"; // 'Daily', 'Weekly', or 'Monthly'
      const DAYS_PER_YEAR = 365.25; // Use 365.25 for average
      const WEEKS_PER_YEAR = 52.14; // Use 52.14 for average
      const MONTHS_PER_YEAR = 12; // Remains 12

      // DOM elements
      const themeToggle = document.getElementById("themeToggle");
      const sunIcon = document.getElementById("sunIcon");
      const moonIcon = document.getElementById("moonIcon");
      const body = document.body;

      // Mode Toggles
      const sipModeBtn = document.getElementById("sipModeBtn");
      const lumpsumModeBtn = document.getElementById("lumpsumModeBtn");
      const swpModeBtn = document.getElementById("swpModeBtn");

      // Frequency Card
      const frequencyCard = document.getElementById("frequencyCard");
      const frequencyTitle = document.getElementById("frequencyTitle");
      const freqButtons = document.querySelectorAll("#frequencyCard button");

      // Input Elements
      const principalLabel = document.getElementById("principalLabel");
      const principalInput = document.getElementById("principalAmount");
      const principalSlider = document.getElementById("principalAmountSlider");
      const principalMin = document.getElementById("principalMin");
      const principalMax = document.getElementById("principalMax");

      const rateInput = document.getElementById("expectedReturn");
      const rateSlider = document.getElementById("expectedReturnSlider");

      const durationLabel = document.getElementById("durationLabel");
      const durationInput = document.getElementById("duration");
      const durationSlider = document.getElementById("durationSlider");

      const swpWithdrawalInput = document.getElementById("swpWithdrawalInput");
      const withdrawalRateInput = document.getElementById("withdrawalRate");
      const withdrawalRateSlider = document.getElementById(
        "withdrawalRateSlider"
      );

      // Result Elements
      const resultsTitle = document.getElementById("resultsTitle");
      const metric1Label = document.getElementById("metric1Label");
      const metric1Value = document.getElementById("metric1Value");
      const metric2Label = document.getElementById("metric2Label");
      const metric2Value = document.getElementById("metric2Value");
      const metric3Label = document.getElementById("metric3Label");
      const metric3Value = document.getElementById("metric3Value");
      const swpWarning = document.getElementById("swpWarning");
      const swpWarningText = document.getElementById("swpWarningText");
      const pieChartTitle = document.getElementById("pieChartTitle");
      const lineChartTitle = document.getElementById("lineChartTitle");

      let pieChart, lineChart;

      // --- Utility Functions ---

      /**
       * Formats a number to Indian Rupee style (lakhs/crores).
       * @param {number} num - The number to format.
       * @returns {string} The formatted string prefixed with ₹.
       */
      function formatINR(num) {
        if (typeof num !== "number" || isNaN(num)) return "₹0";
        const numStr = Math.round(num).toString();
        let lastThree = numStr.substring(numStr.length - 3);
        const otherNumbers = numStr.substring(0, numStr.length - 3);

        if (otherNumbers !== "") {
          lastThree = "," + lastThree;
        }

        // Regex for placing commas after every two digits (Indian system)
        const formatted =
          otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree;
        return `₹${formatted}`;
      }

      // --- Core Calculation Logic ---

      /**
       * Calculates Future Value (FV) for SIP based on frequency.
       */
      function calculateSIPV(P, r, t, periodsPerYear) {
        const i = r / periodsPerYear; // Periodic rate
        const n = t * periodsPerYear; // Total number of periods

        if (r === 0) return P * n;

        const totalPeriods = Math.round(n);
        // Standard FV of Annuity formula, compounded at the start of the period
        return P * ((Math.pow(1 + i, totalPeriods) - 1) / i) * (1 + i);
      }

      /**
       * Calculates Future Value (FV) for Lumpsum.
       */
      function calculateLumpsumV(P, r, t) {
        return P * Math.pow(1 + r, t);
      }

      /**
       * Calculates the Systematic Withdrawal Plan (SWP) projection.
       * This simulates the monthly growth and withdrawal process.
       */
      function calculateSWP(
        initialCorpus,
        growthRateAnnual,
        withdrawalRateAnnual,
        years,
        periodsPerYear
      ) {
        const totalAnnualWithdrawal = initialCorpus * withdrawalRateAnnual;
        const withdrawalPerPeriod = totalAnnualWithdrawal / periodsPerYear;
        const ratePerPeriod = growthRateAnnual / periodsPerYear;

        let currentCorpus = initialCorpus;
        let totalWithdrawn = 0;
        let exhaustionYear = null;
        let annualGrowth = [];

        for (let year = 1; year <= years; year++) {
          let yearEndCorpus = currentCorpus;
          let annualGrowthAccumulated = 0;
          let annualWithdrawn = 0;

          if (exhaustionYear) {
            // If corpus is already exhausted, just track zero
            annualGrowth.push({ year: year, value: 0 });
            continue;
          }

          for (let period = 1; period <= periodsPerYear; period++) {
            // 1. Calculate growth for the current period
            const periodGrowth = yearEndCorpus * ratePerPeriod;

            // 2. Add growth
            yearEndCorpus += periodGrowth;
            annualGrowthAccumulated += periodGrowth;

            // 3. Apply withdrawal (at the end of the period)
            let actualWithdrawal = withdrawalPerPeriod;
            if (yearEndCorpus >= withdrawalPerPeriod) {
              yearEndCorpus -= withdrawalPerPeriod;
              annualWithdrawn += withdrawalPerPeriod;
            } else {
              // Corpus exhaustion
              actualWithdrawal = yearEndCorpus;
              yearEndCorpus = 0;
              annualWithdrawn += actualWithdrawal;
              exhaustionYear = year;
              break; // End periods for this year
            }
          }

          // Update for next iteration
          currentCorpus = yearEndCorpus;
          totalWithdrawn += annualWithdrawn;

          // Track annual values for chart
          annualGrowth.push({
            year: year,
            corpus: currentCorpus,
            withdrawn: annualWithdrawn,
            totalWithdrawn: totalWithdrawn,
          });

          if (exhaustionYear) break;
        }

        return {
          finalCorpus: currentCorpus,
          totalWithdrawn: totalWithdrawn,
          exhaustionYear: exhaustionYear,
          annualData: annualGrowth,
          totalAnnualWithdrawal: totalAnnualWithdrawal,
        };
      }

      // --- Chart & UI Update Functions ---

      function updateCharts(data, mode) {
        let labels,
          dataInvested,
          dataReturns,
          dataCorpus,
          dataWithdrawn,
          color1,
          color2,
          label1,
          label2;

        if (mode === "SWP") {
          const finalCorpus = data.finalCorpus;
          const totalWithdrawn = data.totalWithdrawn;

          // Pie Chart Data: Final state breakdown
          labels = ["Corpus Remaining", "Total Withdrawn"];
          dataInvested = finalCorpus;
          dataReturns = totalWithdrawn; // Using totalWithdrawn as the second metric
          color1 = "rgba(99, 102, 241, 1)"; // Primary (Corpus)
          color2 = "rgba(16, 185, 129, 1)"; // Green (Withdrawn)

          // Line Chart Data: Corpus and Total Withdrawn over time
          labels = data.annualData.map((g) => g.year);
          dataCorpus = data.annualData.map((g) => g.corpus);
          dataWithdrawn = data.annualData.map((g) => g.totalWithdrawn);
          label1 = "Corpus Remaining";
          label2 = "Total Amount Withdrawn";
        } else {
          // SIP or Lumpsum
          const totalInvested = data.totalInvested;
          const estimatedReturns = data.finalValue - totalInvested;

          // Pie Chart Data: Final state breakdown
          labels = ["Total Invested", "Estimated Returns"];
          dataInvested = totalInvested;
          dataReturns = estimatedReturns;
          color1 = "rgba(99, 102, 241, 1)"; // Primary (Invested)
          color2 = "rgba(16, 185, 129, 1)"; // Green (Returns)

          // Line Chart Data: Total Value over time
          labels = data.annualGrowth.map((g) => g.year);
          dataCorpus = data.annualGrowth.map((g) => g.value);
          dataWithdrawn = data.annualGrowth.map((g) => g.invested);
          label1 = "Maturity Value";
          label2 = "Total Invested";
        }

        // --- Pie Chart Update ---
        const pieData = {
          labels: labels,
          datasets: [
            {
              data: [dataInvested, dataReturns],
              backgroundColor: [color1, color2],
              hoverOffset: 10,
            },
          ],
        };

        const pieConfig = {
          type: "doughnut",
          data: pieData,
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            cutout: "70%",
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: body.classList.contains("dark")
                    ? "#f1f5f9"
                    : "#1e293b",
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    if (label) {
                      let value = context.parsed;
                      return `${label}: ${formatINR(value)}`;
                    }
                    return "";
                  },
                },
              },
              datalabels: {
                formatter: (value, context) => {
                  const total = context.chart.data.datasets[0].data.reduce(
                    (a, b) => a + b,
                    0
                  );
                  // Prevent division by zero if all values are 0
                  if (total === 0) return "0%";
                  const percentage = ((value / total) * 100).toFixed(1) + "%";
                  return percentage;
                },
                color: "#fff",
                font: { weight: "bold" },
              },
            },
          },
        };

        if (pieChart) {
          pieChart.data = pieData;
          pieChart.options.plugins.legend.labels.color =
            body.classList.contains("dark") ? "#f1f5f9" : "#1e293b";
          pieChart.update();
        } else {
          pieChart = new Chart(document.getElementById("pieChart"), pieConfig);
        }

        // --- Line Chart Update ---
        const lineData = {
          labels: labels,
          datasets: [
            {
              label: label1,
              data: dataCorpus,
              borderColor: "rgba(129, 140, 248, 1)", // Indigo-400 (Value/Corpus)
              backgroundColor: "rgba(129, 140, 248, 0.5)",
              fill: "start",
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 5,
              order: 1, // Ensure corpus/value line is drawn first
            },
            {
              label: label2,
              data: dataWithdrawn,
              borderColor: "rgba(16, 185, 129, 1)", // Green (Invested/Withdrawn)
              backgroundColor: "rgba(16, 185, 129, 0.2)",
              fill: false,
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 5,
              borderDash: mode === "SWP" ? [5, 5] : [], // Dashed line for SWP total withdrawn
              order: 2,
            },
          ],
        };

        const lineConfig = {
          type: "line",
          data: lineData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: body.classList.contains("dark")
                    ? "rgba(255,255,255,0.1)"
                    : "rgba(0,0,0,0.1)",
                },
                ticks: {
                  color: body.classList.contains("dark")
                    ? "#f1f5f9"
                    : "#1e293b",
                  callback: function (value) {
                    if (value >= 10000000)
                      return formatINR(value / 10000000) + " Cr";
                    if (value >= 100000)
                      return formatINR(value / 100000) + " L";
                    return formatINR(value);
                  },
                },
              },
              x: {
                grid: { display: false },
                ticks: {
                  color: body.classList.contains("dark")
                    ? "#f1f5f9"
                    : "#1e293b",
                },
              },
            },
            plugins: {
              legend: {
                position: "top",
                labels: {
                  color: body.classList.contains("dark")
                    ? "#f1f5f9"
                    : "#1e293b",
                  usePointStyle: true,
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || "";
                    if (label) {
                      label += ": ";
                    }
                    if (context.parsed.y !== null) {
                      label += formatINR(context.parsed.y);
                    }
                    return label;
                  },
                },
              },
            },
          },
        };

        if (lineChart) {
          lineChart.data = lineData;
          // Theme updates for line chart
          const isDark = body.classList.contains("dark");
          lineChart.options.scales.y.grid.color = isDark
            ? "rgba(255,255,255,0.1)"
            : "rgba(0,0,0,0.1)";
          lineChart.options.scales.y.ticks.color = isDark
            ? "#f1f5f9"
            : "#1e293b";
          lineChart.options.scales.x.ticks.color = isDark
            ? "#f1f5f9"
            : "#1e293b";
          lineChart.options.plugins.legend.labels.color = isDark
            ? "#f1f5f9"
            : "#1e293b";
          lineChart.update();
        } else {
          lineChart = new Chart(
            document.getElementById("lineChart"),
            lineConfig
          );
        }
      }

      /**
       * Handles the change in frequency (Daily/Weekly/Monthly) for SIP/SWP
       */
      function handleFrequencyChange(frequency) {
        periodFrequency = frequency;

        // UI Button styling for frequency
        freqButtons.forEach((btn) => {
          if (btn.dataset.freq === frequency) {
            btn.classList.add(
              "bg-white",
              "dark:bg-slate-600",
              "text-indigo-600",
              "dark:text-indigo-400",
              "shadow-md"
            );
            btn.classList.remove(
              "text-gray-600",
              "dark:text-gray-300",
              "hover:bg-white/50",
              "dark:hover:bg-slate-500/50"
            );
          } else {
            btn.classList.remove(
              "bg-white",
              "dark:bg-slate-600",
              "text-indigo-600",
              "dark:text-indigo-400",
              "shadow-md"
            );
            btn.classList.add(
              "text-gray-600",
              "dark:text-gray-300",
              "hover:bg-white/50",
              "dark:hover:bg-slate-500/50"
            );
          }
        });

        calculateAndRender();
      }

      /**
       * Main function to read inputs, perform calculation, and update UI/Charts.
       */
      function calculateAndRender() {
        const P = parseFloat(principalInput.value) || 0; // Principal (SIP Amt / Lumpsum Amt / Initial Corpus)
        const R_annual = (parseFloat(rateInput.value) || 0) / 100; // Annual Growth Rate
        const T = parseInt(durationInput.value) || 0; // Duration in Years
        const W_rate_annual =
          (parseFloat(withdrawalRateInput.value) || 0) / 100; // Annual Withdrawal Rate (SWP only)

        // Clear warning
        swpWarning.classList.add("hidden");

        if (calculationMode === "SWP") {
          let periodsPerYear = MONTHS_PER_YEAR; // SWP is typically monthly

          // Check for valid inputs
          if (P <= 0 || R_annual <= 0 || T <= 0 || W_rate_annual <= 0) {
            // Reset results if inputs are invalid
            updateSWPResults(0, 0, 0, null, 0); // Added 5th parameter for totalAnnualWithdrawal
            return;
          }

          const result = calculateSWP(
            P,
            R_annual,
            W_rate_annual,
            T,
            periodsPerYear
          );

          // Update Results UI
          updateSWPResults(
            P,
            result.totalWithdrawn,
            result.finalCorpus,
            result.exhaustionYear,
            result.totalAnnualWithdrawal
          );

          // Update Charts
          updateCharts(result, "SWP");
        } else if (calculationMode === "SIP") {
          let periodsPerYear;
          switch (periodFrequency) {
            case "Daily":
              periodsPerYear = DAYS_PER_YEAR;
              break;
            case "Weekly":
              periodsPerYear = WEEKS_PER_YEAR;
              break;
            case "Monthly":
            default:
              periodsPerYear = MONTHS_PER_YEAR;
          }

          let finalValue = 0;
          let totalInvested = 0;
          let annualGrowth = [];

          const totalPeriods = T * periodsPerYear;
          totalInvested = P * totalPeriods;

          // Calculate annual growth for Line Chart
          for (let t = 1; t <= T; t++) {
            const value = calculateSIPV(P, R_annual, t, periodsPerYear);
            const invested = P * Math.round(t * periodsPerYear);
            annualGrowth.push({ year: t, value: value, invested: invested });
          }
          finalValue = calculateSIPV(P, R_annual, T, periodsPerYear);

          // Update Results UI
          updateInvestmentResults(totalInvested, finalValue);

          // Update Charts
          updateCharts({ totalInvested, finalValue, annualGrowth }, "SIP");
        } else {
          // Lumpsum mode
          let finalValue = 0;
          let totalInvested = P;
          let annualGrowth = [];

          // Calculate annual growth for Line Chart
          for (let t = 1; t <= T; t++) {
            const value = calculateLumpsumV(P, R_annual, t);
            annualGrowth.push({
              year: t,
              value: value,
              invested: totalInvested,
            });
          }
          finalValue = calculateLumpsumV(P, R_annual, T);

          // Update Results UI
          updateInvestmentResults(totalInvested, finalValue);

          // Update Charts
          updateCharts({ totalInvested, finalValue, annualGrowth }, "Lumpsum");
        }
      }

      // --- Results UI Update Functions ---

      function updateInvestmentResults(totalInvested, finalValue) {
        const estimatedReturns = Math.max(0, finalValue - totalInvested);

        resultsTitle.textContent = "Maturity Projection";
        metric1Label.textContent = "Total Invested Amount";
        metric1Value.textContent = formatINR(totalInvested);
        metric2Label.textContent = "Estimated Returns";
        metric2Value.textContent = formatINR(estimatedReturns);

        // Fix: Ensure we are removing and adding classes individually
        metric2Value.classList.remove("text-red-600", "dark:text-red-400");
        metric2Value.classList.add("text-green-600", "dark:text-green-400");

        metric3Label.textContent = "Final Maturity Value";
        metric3Value.textContent = formatINR(finalValue);
      }

      function updateSWPResults(
        initialCorpus,
        totalWithdrawn,
        finalCorpus,
        exhaustionYear,
        totalAnnualWithdrawal
      ) {
        const netGainLoss = finalCorpus + totalWithdrawn - initialCorpus;

        resultsTitle.textContent = "Withdrawal Sustainability";

        metric1Label.textContent = "Initial Corpus";
        metric1Value.textContent = formatINR(initialCorpus);

        metric2Label.textContent = "Total Amount Withdrawn";
        metric2Value.textContent = formatINR(totalWithdrawn);

        // Fix: Remove all color classes before applying the correct ones
        metric2Value.classList.remove(
          "text-green-600",
          "dark:text-green-400",
          "text-red-600",
          "dark:text-red-400"
        );

        if (netGainLoss >= 0) {
          metric2Value.classList.add("text-green-600", "dark:text-green-400");
        } else {
          metric2Value.classList.add("text-red-600", "dark:text-red-400");
        }

        metric3Label.textContent = "Final Corpus";
        metric3Value.textContent = formatINR(finalCorpus);

        pieChartTitle.textContent = "Corpus Remaining vs. Total Withdrawn";
        lineChartTitle.textContent = "Corpus & Withdrawal Over Time";

        // Show warning if exhausted
        if (exhaustionYear !== null) {
          swpWarning.classList.remove("hidden");
          swpWarningText.textContent = `WARNING: Corpus was exhausted in Year ${exhaustionYear}. Total withdrawal potential was reduced.`;
        } else {
          swpWarning.classList.add("hidden");
        }
      }

      // --- Event Handlers & Initialisation ---

      function handleModeChange(mode) {
        calculationMode = mode;
        const isSWP = mode === "SWP";
        const isLumpsum = mode === "Lumpsum";
        const isSIP = mode === "SIP";

        // --- Button Styling ---
        document.querySelectorAll(".flex-1.py-2.px-2").forEach((btn) => {
          btn.classList.remove(
            "bg-white",
            "dark:bg-slate-600",
            "text-indigo-600",
            "dark:text-indigo-400",
            "shadow-md"
          );
          btn.classList.add(
            "text-gray-600",
            "dark:text-gray-300",
            "hover:bg-white/50",
            "dark:hover:bg-slate-500/50"
          );
        });
        document
          .getElementById(`${mode.toLowerCase()}ModeBtn`)
          .classList.add(
            "bg-white",
            "dark:bg-slate-600",
            "text-indigo-600",
            "dark:text-indigo-400",
            "shadow-md"
          );
        document
          .getElementById(`${mode.toLowerCase()}ModeBtn`)
          .classList.remove(
            "text-gray-600",
            "dark:text-gray-300",
            "hover:bg-white/50",
            "dark:hover:bg-slate-500/50"
          );

        // --- Input Visibility and Labels ---
        frequencyCard.classList.toggle("hidden", isLumpsum);
        swpWithdrawalInput.classList.toggle("hidden", !isSWP);

        if (isSWP) {
          // SWP Defaults
          principalLabel.textContent = "Initial Corpus (₹)";
          durationLabel.textContent = "Withdrawal Duration (Years)";
          frequencyTitle.textContent = "Withdrawal Frequency (Monthly Only)";
          principalInput.min = 500000;
          principalInput.max = 100000000;
          principalInput.step = 100000;
          principalInput.value = 10000000;

          // SWP Sliders
          principalSlider.min = 500000;
          principalSlider.max = 100000000;
          principalSlider.step = 100000;
          principalSlider.value = 10000000;

          // Disable Daily/Weekly for SWP (typically monthly)
          document.getElementById("weeklyFreqBtn").disabled = true;
          document.getElementById("dailyFreqBtn").disabled = true;
          document.getElementById("monthlyFreqBtn").click(); // Force monthly

          // Reset withdrawal rate if needed
          if (parseFloat(withdrawalRateInput.value) === 0) {
            withdrawalRateInput.value = 4;
            withdrawalRateSlider.value = 4;
          }
        } else if (isSIP) {
          // SIP Defaults
          principalLabel.textContent = `Monthly Investment (₹)`;
          durationLabel.textContent = "Investment Duration (Years)";
          frequencyTitle.textContent = "SIP Frequency";
          principalInput.min = 500;
          principalInput.max = 100000;
          principalInput.step = 500;
          principalInput.value = 5000;

          // SIP Sliders
          principalSlider.min = 500;
          principalSlider.max = 100000;
          principalSlider.step = 500;
          principalSlider.value = 5000;

          // Re-enable frequency buttons
          document.getElementById("weeklyFreqBtn").disabled = false;
          document.getElementById("dailyFreqBtn").disabled = false;
          handleFrequencyChange(periodFrequency); // Re-run to update label/sliders
        } else {
          // Lumpsum Defaults
          principalLabel.textContent = "One-Time Investment Amount (₹)";
          durationLabel.textContent = "Investment Duration (Years)";

          principalInput.min = 5000;
          principalInput.max = 5000000;
          principalInput.step = 1000;
          principalInput.value = 100000;

          // Lumpsum Sliders
          principalSlider.min = 5000;
          principalSlider.max = 5000000;
          principalSlider.step = 1000;
          principalSlider.value = 100000;
        }

        // Update Slider Min/Max Labels
        principalMin.textContent = formatINR(parseFloat(principalSlider.min));
        principalMax.textContent = formatINR(parseFloat(principalSlider.max));

        calculateAndRender();
      }

      // Sync slider and input value
      function syncSliders() {
        const inputs = [
          { input: principalInput, slider: principalSlider },
          { input: rateInput, slider: rateSlider },
          { input: durationInput, slider: durationSlider },
          { input: withdrawalRateInput, slider: withdrawalRateSlider },
        ];

        inputs.forEach(({ input, slider }) => {
          // Check if element exists before attaching listener
          if (input && slider) {
            input.addEventListener("input", () => {
              slider.value = input.value;
              calculateAndRender();
            });
            slider.addEventListener("input", () => {
              input.value = slider.value;
              calculateAndRender();
            });
          }
        });
      }

      function setupModeToggles() {
        sipModeBtn.addEventListener("click", () => handleModeChange("SIP"));
        lumpsumModeBtn.addEventListener("click", () =>
          handleModeChange("Lumpsum")
        );
        swpModeBtn.addEventListener("click", () => handleModeChange("SWP"));

        // Frequency Toggles
        freqButtons.forEach((btn) => {
          btn.addEventListener("click", (e) =>
            handleFrequencyChange(e.currentTarget.dataset.freq)
          );
        });
      }

      // Dark/Light Mode Toggle (Original functionality retained)
      function initTheme() {
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        const currentTheme = localStorage.getItem("theme");

        if (currentTheme === "dark" || (!currentTheme && prefersDark)) {
          body.classList.add("dark");
          moonIcon.classList.add("hidden");
          sunIcon.classList.remove("hidden");
        } else {
          body.classList.remove("dark");
          moonIcon.classList.remove("hidden");
          sunIcon.classList.add("hidden");
        }

        themeToggle.addEventListener("click", () => {
          body.classList.toggle("dark");
          const isDark = body.classList.contains("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");

          // Toggle icons
          moonIcon.classList.toggle("hidden", isDark);
          sunIcon.classList.toggle("hidden", !isDark);

          // Update charts colors on theme change
          // Note: updateCharts is called by calculateAndRender, but we need manual update for theme changes
          // if no input values changed.
          if (pieChart) {
            pieChart.options.plugins.legend.labels.color = isDark
              ? "#f1f5f9"
              : "#1e293b";
            pieChart.update();
          }
          if (lineChart) {
            lineChart.options.scales.y.grid.color = isDark
              ? "rgba(255,255,255,0.1)"
              : "rgba(0,0,0,0.1)";
            lineChart.options.scales.y.ticks.color = isDark
              ? "#f1f5f9"
              : "#1e293b";
            lineChart.options.scales.x.ticks.color = isDark
              ? "#f1f5f9"
              : "#1e293b";
            lineChart.options.plugins.legend.labels.color = isDark
              ? "#f1f5f9"
              : "#1e293b";
            lineChart.update();
          }
        });
      }

      // Initialisation
      window.onload = function () {
        initTheme();
        syncSliders();
        setupModeToggles();
        // Start with SIP mode and initial calculation
        handleModeChange("SIP");
      };
    </script>
  </body>
</html>
