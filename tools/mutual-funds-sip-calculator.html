<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fintech Investment Calculator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for dynamic charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Load Chart.js Datalabels Plugin for Pie Chart labels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
      /* Define custom Tailwind configuration */
      :root {
        --primary-color: #6366f1; /* Indigo-500 */
        --background-start: #f1f5f9; /* Slate-100 (Light) */
        --background-end: #e2e8f0; /* Slate-200 (Light) */
        --card-bg: rgba(255, 255, 255, 0.85); /* Light Glass */
        --text-color: #1e293b; /* Slate-800 */
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .dark {
        --background-start: #1e293b; /* Slate-800 (Dark) */
        --background-end: #0f172a; /* Slate-900 (Dark) */
        --card-bg: rgba(30, 41, 59, 0.7); /* Dark Glass */
        --text-color: #f1f5f9; /* Slate-100 */
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(
          135deg,
          var(--background-start),
          var(--background-end)
        );
        min-height: 100vh;
        color: var(--text-color);
        transition: background 0.5s ease, color 0.5s ease;
      }

      /* Glassmorphism Card Style */
      .glass-card {
        background-color: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
        box-shadow: var(--shadow);
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      /* Custom Slider Styling for better contrast */
      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        background: #cbd5e1; /* Slate-300 */
        border-radius: 4px;
        outline: none;
        transition: opacity 0.2s;
      }

      .dark input[type="range"] {
        background: #475569; /* Slate-600 */
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: background 0.3s;
      }

      /* Custom scrollbar for subtle look */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 10px;
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <!-- Dark/Light Mode Toggle -->
    <div class="fixed top-4 right-4 z-50">
      <button
        id="themeToggle"
        class="p-3 rounded-full glass-card hover:shadow-lg transition-all duration-300"
      >
        <!-- Moon icon (Dark Mode) -->
        <svg
          id="moonIcon"
          class="w-6 h-6 text-gray-700 dark:text-yellow-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          ></path>
        </svg>
        <!-- Sun icon (Light Mode) -->
        <svg
          id="sunIcon"
          class="w-6 h-6 text-yellow-500 dark:text-gray-200 hidden"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Main Application Container -->
    <main class="max-w-6xl mx-auto py-4">
      <h1
        class="text-3xl md:text-4xl font-extrabold mb-8 text-center bg-clip-text text-transparent"
        style="
          background-image: linear-gradient(
            90deg,
            var(--primary-color),
            #8b5cf6
          );
        "
      >
        Mutual Fund Goal Planner
      </h1>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Inputs and Results (Col 1/3) -->
        <div class="lg:col-span-1 space-y-6">
          <!-- Investment Mode Toggle -->
          <div class="glass-card p-4 rounded-xl">
            <h2 class="text-xl font-semibold mb-3">Investment Type</h2>
            <div
              class="flex space-x-2 p-1 bg-gray-200 dark:bg-slate-700 rounded-lg transition-colors duration-300"
            >
              <button
                id="sipModeBtn"
                class="flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-300 bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-400 shadow-md"
              >
                Systematic Investment Plan (SIP)
              </button>
              <button
                id="lumpsumModeBtn"
                class="flex-1 py-2 px-4 rounded-lg font-medium transition-all duration-300 text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-500/50"
              >
                One-Time Lumpsum
              </button>
            </div>
          </div>

          <!-- NEW: SIP Frequency Selector -->
          <div id="sipFrequencyCard" class="glass-card p-4 rounded-xl">
            <h2 class="text-xl font-semibold mb-3">SIP Frequency</h2>
            <div
              class="flex space-x-2 p-1 bg-gray-200 dark:bg-slate-700 rounded-lg text-sm transition-colors duration-300"
            >
              <button
                id="monthlyFreqBtn"
                data-freq="Monthly"
                class="flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 bg-white dark:bg-slate-600 text-indigo-600 dark:text-indigo-400 shadow-md"
              >
                Monthly
              </button>
              <button
                id="weeklyFreqBtn"
                data-freq="Weekly"
                class="flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-500/50"
              >
                Weekly
              </button>
              <button
                id="dailyFreqBtn"
                data-freq="Daily"
                class="flex-1 py-2 px-3 rounded-lg font-medium transition-all duration-300 text-gray-600 dark:text-gray-300 hover:bg-white/50 dark:hover:bg-slate-500/50"
              >
                Daily
              </button>
            </div>
          </div>

          <!-- Input Controls Card -->
          <div class="glass-card p-6 rounded-xl">
            <h2 class="text-xl font-semibold mb-4">Investment Parameters</h2>

            <!-- 1. Investment Amount Input (SIP/Lumpsum) -->
            <div class="mb-5">
              <label
                for="investmentAmount"
                class="block text-sm font-medium mb-2"
                id="amountLabel"
                >Monthly Investment (₹)</label
              >
              <div class="relative mb-2">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                  >₹</span
                >
                <input
                  type="number"
                  id="investmentAmount"
                  value="5000"
                  min="500"
                  max="100000"
                  step="500"
                  class="w-full py-3 pl-8 pr-4 rounded-lg border-2 border-indigo-200 dark:border-indigo-800 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-slate-700 text-sm transition-colors duration-300"
                />
              </div>
              <input
                type="range"
                id="investmentAmountSlider"
                min="500"
                max="100000"
                step="500"
                value="5000"
                class="w-full h-2 rounded-full cursor-pointer"
              />
              <div class="flex justify-between text-xs mt-1 text-gray-500">
                <span>₹500</span><span>₹1,00,000</span>
              </div>
            </div>

            <!-- 2. Expected Annual Return (%) -->
            <div class="mb-5">
              <label for="expectedReturn" class="block text-sm font-medium mb-2"
                >Expected Annual Return (%)</label
              >
              <div class="relative mb-2">
                <input
                  type="number"
                  id="expectedReturn"
                  value="12"
                  min="1"
                  max="30"
                  step="0.5"
                  class="w-full py-3 pr-8 pl-4 rounded-lg border-2 border-indigo-200 dark:border-indigo-800 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-slate-700 text-sm transition-colors duration-300"
                />
                <span
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                  >%</span
                >
              </div>
              <input
                type="range"
                id="expectedReturnSlider"
                min="1"
                max="30"
                step="0.5"
                value="12"
                class="w-full h-2 rounded-full cursor-pointer"
              />
              <div class="flex justify-between text-xs mt-1 text-gray-500">
                <span>1%</span><span>30%</span>
              </div>
            </div>

            <!-- 3. Investment Duration (Years) -->
            <div class="mb-2">
              <label
                for="investmentDuration"
                class="block text-sm font-medium mb-2"
                >Investment Duration (Years)</label
              >
              <div class="relative mb-2">
                <input
                  type="number"
                  id="investmentDuration"
                  value="10"
                  min="1"
                  max="100"
                  step="1"
                  class="w-full py-3 pr-10 pl-4 rounded-lg border-2 border-indigo-200 dark:border-indigo-800 focus:ring-indigo-500 focus:border-indigo-500 bg-white dark:bg-slate-700 text-sm transition-colors duration-300"
                />
                <span
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                  >Yrs</span
                >
              </div>
              <input
                type="range"
                id="investmentDurationSlider"
                min="1"
                max="100"
                step="1"
                value="10"
                class="w-full h-2 rounded-full cursor-pointer"
              />
              <div class="flex justify-between text-xs mt-1 text-gray-500">
                <span>1 Yr</span><span>100 Yrs</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Results and Charts (Col 2/3 and 3/3) -->
        <div class="lg:col-span-2 space-y-8">
          <!-- Results Display Card -->
          <div class="glass-card p-6 rounded-xl transition-all duration-300">
            <h2
              class="text-2xl font-bold text-center mb-6 text-indigo-600 dark:text-indigo-400"
            >
              Maturity Projection
            </h2>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <!-- Total Invested -->
              <div
                class="text-center p-3 border-b-2 sm:border-b-0 sm:border-r-2 border-indigo-200 dark:border-indigo-800"
              >
                <p class="text-sm font-medium opacity-75">
                  Total Invested Amount
                </p>
                <p
                  id="totalInvested"
                  class="text-xl md:text-2xl font-extrabold mt-1 text-gray-700 dark:text-gray-200"
                >
                  ₹0
                </p>
              </div>
              <!-- Estimated Returns -->
              <div
                class="text-center p-3 border-b-2 sm:border-b-0 sm:border-r-2 border-indigo-200 dark:border-indigo-800"
              >
                <p class="text-sm font-medium opacity-75">Estimated Returns</p>
                <p
                  id="estimatedReturns"
                  class="text-xl md:text-2xl font-extrabold mt-1 text-green-600 dark:text-green-400"
                >
                  ₹0
                </p>
              </div>
              <!-- Final Value -->
              <div class="text-center p-3">
                <p class="text-sm font-medium opacity-75">
                  Final Maturity Value
                </p>
                <p
                  id="finalMaturityValue"
                  class="text-2xl md:text-3xl font-black mt-1 text-indigo-700 dark:text-indigo-300"
                >
                  ₹0
                </p>
              </div>
            </div>
          </div>

          <!-- Charts and Visualization -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Pie Chart: Invested vs Returns -->
            <div class="glass-card p-6 rounded-xl">
              <h3 class="text-lg font-semibold mb-4 text-center">
                Invested vs. Returns (Final Value Composition)
              </h3>
              <canvas id="pieChart" class="w-full"></canvas>
            </div>

            <!-- Line Chart: Growth Over Years -->
            <div class="glass-card p-6 rounded-xl">
              <h3 class="text-lg font-semibold mb-4 text-center">
                Investment Growth Over Time
              </h3>
              <canvas id="lineChart" class="w-full"></canvas>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // Global state and constants
      let investmentMode = "SIP"; // 'SIP' or 'Lumpsum'
      let sipFrequency = "Monthly"; // 'Daily', 'Weekly', or 'Monthly'
      const DAYS_PER_YEAR = 365.25; // Use 365.25 for average
      const WEEKS_PER_YEAR = 52.14; // Use 52.14 for average
      const MONTHS_PER_YEAR = 12; // Remains 12

      // DOM elements
      const themeToggle = document.getElementById("themeToggle");
      const sunIcon = document.getElementById("sunIcon");
      const moonIcon = document.getElementById("moonIcon");
      const body = document.body;

      const sipModeBtn = document.getElementById("sipModeBtn");
      const lumpsumModeBtn = document.getElementById("lumpsumModeBtn");

      const sipFrequencyCard = document.getElementById("sipFrequencyCard");
      const freqButtons = document.querySelectorAll("#sipFrequencyCard button");

      const amountLabel = document.getElementById("amountLabel");
      const amountInput = document.getElementById("investmentAmount");
      const amountSlider = document.getElementById("investmentAmountSlider");
      const rateInput = document.getElementById("expectedReturn");
      const rateSlider = document.getElementById("expectedReturnSlider");
      const durationInput = document.getElementById("investmentDuration");
      const durationSlider = document.getElementById(
        "investmentDurationSlider"
      );

      const totalInvestedEl = document.getElementById("totalInvested");
      const estimatedReturnsEl = document.getElementById("estimatedReturns");
      const finalMaturityValueEl =
        document.getElementById("finalMaturityValue");

      let pieChart, lineChart;

      // --- Utility Functions ---

      /**
       * Formats a number to Indian Rupee style (lakhs/crores).
       * @param {number} num - The number to format.
       * @returns {string} The formatted string prefixed with ₹.
       */
      function formatINR(num) {
        if (typeof num !== "number" || isNaN(num)) return "₹0";
        const numStr = Math.round(num).toString();
        let lastThree = numStr.substring(numStr.length - 3);
        const otherNumbers = numStr.substring(0, numStr.length - 3);

        if (otherNumbers !== "") {
          lastThree = "," + lastThree;
        }

        // Regex for placing commas after every two digits (Indian system)
        const formatted =
          otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree;
        return `₹${formatted}`;
      }

      // --- Core Calculation Logic ---

      /**
       * Calculates Future Value (FV) for SIP based on frequency.
       * FV = P * [ ((1 + i)^n - 1) / i ] * (1 + i)
       * Where i = r/periodsPerYear, n = total periods
       * @param {number} P - Investment amount per period.
       * @param {number} r - Annual rate of return (as decimal, e.g., 0.12).
       * @param {number} t - Duration in years.
       * @param {number} periodsPerYear - Number of investment periods per year.
       * @returns {number} The final maturity value.
       */
      function calculateSIPV(P, r, t, periodsPerYear) {
        const i = r / periodsPerYear; // Periodic rate
        const n = t * periodsPerYear; // Total number of periods

        if (r === 0) return P * n; // Simple investment without returns

        const totalPeriods = Math.round(n);

        // Standard FV of Annuity formula, compounded at the start of the period
        return P * ((Math.pow(1 + i, totalPeriods) - 1) / i) * (1 + i);
      }

      /**
       * Calculates Future Value (FV) for Lumpsum.
       * FV = P * (1 + r)^t
       * @param {number} P - One-time investment amount.
       * @param {number} r - Annual rate of return (as decimal, e.g., 0.12).
       * @param {number} t - Duration in years.
       * @returns {number} The final maturity value.
       */
      function calculateLumpsumV(P, r, t) {
        return P * Math.pow(1 + r, t);
      }

      // --- Chart & UI Update Functions ---

      function updateCharts(totalInvested, finalValue, annualGrowth) {
        const estimatedReturns = finalValue - totalInvested;

        // 1. Pie Chart Data
        const pieData = {
          labels: ["Total Invested", "Estimated Returns"],
          datasets: [
            {
              data: [totalInvested, estimatedReturns],
              backgroundColor: [
                "rgba(99, 102, 241, 1)", // Primary (Invested)
                "rgba(16, 185, 129, 1)", // Green (Returns)
              ],
              hoverOffset: 10,
            },
          ],
        };

        // Pie Chart Configuration (Chart.js)
        const pieConfig = {
          type: "doughnut",
          data: pieData,
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            cutout: "70%",
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  color: body.classList.contains("dark")
                    ? "#f1f5f9"
                    : "#1e293b",
                },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    if (label) {
                      let value = context.parsed;
                      return `${label}: ${formatINR(value)}`;
                    }
                    return "";
                  },
                },
              },
              datalabels: {
                formatter: (value, context) => {
                  const total = context.chart.data.datasets[0].data.reduce(
                    (a, b) => a + b,
                    0
                  );
                  const percentage = ((value / total) * 100).toFixed(1) + "%";
                  return percentage;
                },
                color: "#fff",
                font: { weight: "bold" },
              },
            },
          },
        };

        if (pieChart) {
          pieChart.data = pieData;
          pieChart.options.plugins.legend.labels.color =
            body.classList.contains("dark") ? "#f1f5f9" : "#1e293b";
          pieChart.update();
        } else {
          pieChart = new Chart(document.getElementById("pieChart"), pieConfig);
        }

        // 2. Line Chart Data
        const labels = annualGrowth.map((g) => g.year);
        const data = annualGrowth.map((g) => g.value);

        const lineData = {
          labels: labels,
          datasets: [
            {
              label: "Maturity Value",
              data: data,
              borderColor: "rgba(129, 140, 248, 1)", // Indigo-400
              backgroundColor: "rgba(129, 140, 248, 0.5)",
              fill: "start",
              tension: 0.4,
              pointRadius: 3,
              pointHoverRadius: 5,
            },
          ],
        };

        const lineConfig = {
          type: "line",
          data: lineData,
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: body.classList.contains("dark")
                    ? "rgba(255,255,255,0.1)"
                    : "rgba(0,0,0,0.1)",
                },
                ticks: {
                  color: body.classList.contains("dark")
                    ? "#f1f5f9"
                    : "#1e293b",
                  callback: function (value) {
                    if (value >= 10000000)
                      return formatINR(value / 10000000) + " Cr";
                    if (value >= 100000)
                      return formatINR(value / 100000) + " L";
                    return formatINR(value);
                  },
                },
              },
              x: {
                grid: { display: false },
                ticks: {
                  color: body.classList.contains("dark")
                    ? "#f1f5f9"
                    : "#1e293b",
                },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || "";
                    if (label) {
                      label += ": ";
                    }
                    if (context.parsed.y !== null) {
                      label += formatINR(context.parsed.y);
                    }
                    return label;
                  },
                },
              },
            },
          },
        };

        if (lineChart) {
          lineChart.data = lineData;
          lineChart.options.scales.y.grid.color = body.classList.contains(
            "dark"
          )
            ? "rgba(255,255,255,0.1)"
            : "rgba(0,0,0,0.1)";
          lineChart.options.scales.y.ticks.color = body.classList.contains(
            "dark"
          )
            ? "#f1f5f9"
            : "#1e293b";
          lineChart.options.scales.x.ticks.color = body.classList.contains(
            "dark"
          )
            ? "#f1f5f9"
            : "#1e293b";
          lineChart.update();
        } else {
          lineChart = new Chart(
            document.getElementById("lineChart"),
            lineConfig
          );
        }
      }

      /**
       * Handles the change in SIP frequency (Daily/Weekly/Monthly)
       */
      function handleFrequencyChange(frequency) {
        sipFrequency = frequency;

        let label, min, max, step, defaultValue;

        // UI Button styling for frequency
        freqButtons.forEach((btn) => {
          if (btn.dataset.freq === frequency) {
            btn.classList.add(
              "bg-white",
              "dark:bg-slate-600",
              "text-indigo-600",
              "dark:text-indigo-400",
              "shadow-md"
            );
            btn.classList.remove(
              "text-gray-600",
              "dark:text-gray-300",
              "hover:bg-white/50",
              "dark:hover:bg-slate-500/50"
            );
          } else {
            btn.classList.remove(
              "bg-white",
              "dark:bg-slate-600",
              "text-indigo-600",
              "dark:text-indigo-400",
              "shadow-md"
            );
            btn.classList.add(
              "text-gray-600",
              "dark:text-gray-300",
              "hover:bg-white/50",
              "dark:hover:bg-slate-500/50"
            );
          }
        });

        // Update amount parameters based on frequency for better range control
        if (frequency === "Daily") {
          label = "Daily Investment (₹)";
          min = 100;
          max = 5000;
          step = 50;
          defaultValue = 500;
        } else if (frequency === "Weekly") {
          label = "Weekly Investment (₹)";
          min = 500;
          max = 25000;
          step = 100;
          defaultValue = 2000;
        } else {
          // Monthly
          label = "Monthly Investment (₹)";
          min = 500;
          max = 100000;
          step = 500;
          defaultValue = 5000;
        }

        amountLabel.textContent = label;
        amountInput.min = min;
        amountInput.max = max;
        amountInput.step = step;
        amountSlider.min = min;
        amountSlider.max = max;
        amountSlider.step = step;

        // Reset or clamp value if outside new range
        const currentValue = parseFloat(amountInput.value);
        if (currentValue > max || currentValue < min || isNaN(currentValue)) {
          amountInput.value = defaultValue;
          amountSlider.value = defaultValue;
        }

        // Sync slider min/max labels (manual update)
        const minLabel = amountSlider.nextElementSibling.children[0];
        const maxLabel = amountSlider.nextElementSibling.children[1];
        minLabel.textContent = formatINR(min);
        maxLabel.textContent = formatINR(max);

        calculateAndRender();
      }

      /**
       * Main function to read inputs, perform calculation, and update UI/Charts.
       */
      function calculateAndRender() {
        const P = parseFloat(amountInput.value) || 0;
        const R_annual = (parseFloat(rateInput.value) || 0) / 100;
        const T = parseInt(durationInput.value) || 0;

        let finalValue = 0;
        let totalInvested = 0;
        let annualGrowth = [];

        if (investmentMode === "SIP") {
          let periodsPerYear, frequencyName;

          switch (sipFrequency) {
            case "Daily":
              periodsPerYear = DAYS_PER_YEAR;
              frequencyName = "Daily";
              break;
            case "Weekly":
              periodsPerYear = WEEKS_PER_YEAR;
              frequencyName = "Weekly";
              break;
            case "Monthly":
            default:
              periodsPerYear = MONTHS_PER_YEAR;
              frequencyName = "Monthly";
          }

          const totalPeriods = T * periodsPerYear;
          // Total Invested is P * Total Periods
          totalInvested = P * totalPeriods;

          // Calculate annual growth for Line Chart
          for (let t = 1; t <= T; t++) {
            const value = calculateSIPV(P, R_annual, t, periodsPerYear);
            annualGrowth.push({ year: t, value: value });
          }
          finalValue = calculateSIPV(P, R_annual, T, periodsPerYear);
        } else {
          // Lumpsum mode
          totalInvested = P;

          // Calculate annual growth for Line Chart
          for (let t = 1; t <= T; t++) {
            const value = calculateLumpsumV(P, R_annual, t);
            annualGrowth.push({ year: t, value: value });
          }
          finalValue = calculateLumpsumV(P, R_annual, T);
        }

        const estimatedReturns = Math.max(0, finalValue - totalInvested);

        // Update result elements
        totalInvestedEl.textContent = formatINR(totalInvested);
        estimatedReturnsEl.textContent = formatINR(estimatedReturns);
        finalMaturityValueEl.textContent = formatINR(finalValue);

        // Update Charts
        updateCharts(totalInvested, finalValue, annualGrowth);
      }

      // --- Event Handlers ---

      function handleModeChange(mode) {
        investmentMode = mode;

        // Toggle SIP Frequency Card visibility
        sipFrequencyCard.classList.toggle("hidden", mode !== "SIP");

        // UI Button styling (SIP/Lumpsum)
        if (mode === "SIP") {
          sipModeBtn.classList.add(
            "bg-white",
            "dark:bg-slate-600",
            "text-indigo-600",
            "dark:text-indigo-400",
            "shadow-md"
          );
          sipModeBtn.classList.remove(
            "text-gray-600",
            "dark:text-gray-300",
            "hover:bg-white/50",
            "dark:hover:bg-slate-500/50"
          );
          lumpsumModeBtn.classList.remove(
            "bg-white",
            "dark:bg-slate-600",
            "text-indigo-600",
            "dark:text-indigo-400",
            "shadow-md"
          );
          lumpsumModeBtn.classList.add(
            "text-gray-600",
            "dark:text-gray-300",
            "hover:bg-white/50",
            "dark:hover:bg-slate-500/50"
          );

          // Re-apply current SIP frequency settings (handles label/slider updates)
          handleFrequencyChange(sipFrequency);
        } else {
          // Lumpsum
          lumpsumModeBtn.classList.add(
            "bg-white",
            "dark:bg-slate-600",
            "text-indigo-600",
            "dark:text-indigo-400",
            "shadow-md"
          );
          lumpsumModeBtn.classList.remove(
            "text-gray-600",
            "dark:text-gray-300",
            "hover:bg-white/50",
            "dark:hover:bg-slate-500/50"
          );
          sipModeBtn.classList.remove(
            "bg-white",
            "dark:bg-slate-600",
            "text-indigo-600",
            "dark:text-indigo-400",
            "shadow-md"
          );
          sipModeBtn.classList.add(
            "text-gray-600",
            "dark:text-gray-300",
            "hover:bg-white/50",
            "dark:hover:bg-slate-500/50"
          );

          amountLabel.textContent = "One-Time Investment Amount (₹)";
          amountInput.min = 5000;
          amountInput.max = 5000000;
          amountInput.step = 1000;
          amountInput.value = 100000;
          amountSlider.min = 5000;
          amountSlider.max = 5000000;
          amountSlider.step = 1000;
          amountSlider.value = 100000;

          // Sync slider min/max labels (manual update)
          const minLabel = amountSlider.nextElementSibling.children[0];
          const maxLabel = amountSlider.nextElementSibling.children[1];
          minLabel.textContent = formatINR(parseFloat(amountSlider.min));
          maxLabel.textContent = formatINR(parseFloat(amountSlider.max));

          calculateAndRender();
        }
      }

      // Sync slider and input value
      function syncSliders() {
        // Amount
        amountInput.addEventListener("input", () => {
          amountSlider.value = amountInput.value;
          calculateAndRender();
        });
        amountSlider.addEventListener("input", () => {
          amountInput.value = amountSlider.value;
          calculateAndRender();
        });

        // Rate
        rateInput.addEventListener("input", () => {
          rateSlider.value = rateInput.value;
          calculateAndRender();
        });
        rateSlider.addEventListener("input", () => {
          rateInput.value = rateSlider.value;
          calculateAndRender();
        });

        // Duration
        durationInput.addEventListener("input", () => {
          durationSlider.value = durationInput.value;
          calculateAndRender();
        });
        durationSlider.addEventListener("input", () => {
          durationInput.value = durationSlider.value;
          calculateAndRender();
        });
      }

      function setupModeToggles() {
        sipModeBtn.addEventListener("click", () => handleModeChange("SIP"));
        lumpsumModeBtn.addEventListener("click", () =>
          handleModeChange("Lumpsum")
        );

        // New Frequency Toggles
        freqButtons.forEach((btn) => {
          btn.addEventListener("click", (e) =>
            handleFrequencyChange(e.currentTarget.dataset.freq)
          );
        });
      }

      // Dark/Light Mode Toggle
      function initTheme() {
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        const currentTheme = localStorage.getItem("theme");

        if (currentTheme === "dark" || (!currentTheme && prefersDark)) {
          body.classList.add("dark");
          moonIcon.classList.add("hidden");
          sunIcon.classList.remove("hidden");
        } else {
          body.classList.remove("dark");
          moonIcon.classList.remove("hidden");
          sunIcon.classList.add("hidden");
        }

        themeToggle.addEventListener("click", () => {
          body.classList.toggle("dark");
          const isDark = body.classList.contains("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");

          // Toggle icons
          moonIcon.classList.toggle("hidden", isDark);
          sunIcon.classList.toggle("hidden", !isDark);

          // Update charts colors on theme change
          if (pieChart) {
            pieChart.options.plugins.legend.labels.color = isDark
              ? "#f1f5f9"
              : "#1e293b";
            pieChart.update();
          }
          if (lineChart) {
            lineChart.options.scales.y.grid.color = isDark
              ? "rgba(255,255,255,0.1)"
              : "rgba(0,0,0,0.1)";
            lineChart.options.scales.y.ticks.color = isDark
              ? "#f1f5f9"
              : "#1e293b";
            lineChart.options.scales.x.ticks.color = isDark
              ? "#f1f5f9"
              : "#1e293b";
            lineChart.update();
          }
        });
      }

      // Initialisation
      window.onload = function () {
        initTheme();
        syncSliders();
        setupModeToggles();
        // Start with SIP mode and initial calculation, which calls handleFrequencyChange('Monthly')
        handleModeChange("SIP");
      };
    </script>
  </body>
</html>
